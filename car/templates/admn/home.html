{% extends 'admn/dashboard.html' %}
{% load crispy_forms_filters %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>

        
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
        <script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>



{% comment %} 
        <script>
          $(document).ready(function() {
            if($('#emplist') != null){
                Read();
            }
            $('#EmployeeRegister').submit(function(event) {
              // Validate the form before submitting
              if (!validateForm()) {
                event.preventDefault(); // Prevent the form from submitting normally
                return false;
              }
              else {
                $.ajax({
                  type: 'post', // Get the form's method attribute
                  url: 'employeeadd', // Get the form's action attribute
                  data: $(this).serialize(), // Serialize the form data
                 
                  success: function(response) {
                    
                    // Handle the server's response here
                    alert('Form submitted successfully!');
                    Read();
                  },
                 
                  error: function(xhr, status, error) {
                    // Handle errors here
                    alert('An error occurred while submitting the form.');
                    console.error(xhr.responseText);
                    
                  }
                });
              }
            });
        
            function validateForm() {
              // Get the form inputs
              var username = $('#id_username').val().trim();
              var password1 = $('#id_password1').val().trim();
              var password2 = $('#id_password2').val().trim();
              var phone = $('#id_phone_number').val().trim();
              var emp_id = $('#id_emp_id').val().trim();
        
              // Check for empty fields
              if (username === '' || password1 === '' || password2 === ''  || phone === '' || emp_id === '') {
                alert('Please fill in all fields.');
                return false;
              }
        
              // Check that passwords match
              if (password1 !== password2) {
                alert('Passwords do not match.');
                return false;
              }
        
              // Check password length
              if (password1.length < 8) {
                alert('Password must be at least 8 characters long.');
                return false;
              }
        
              // Check username length
              if (username.length < 4 || username.length > 20) {
                alert('Username must be between 4 and 20 characters long.');
                return false;
              }
               // Check username duplication
               
            
             
        
              // Check emp_id length
              if (emp_id.length < 6 ) {
                alert('Id must be  6 characters long.');
                return false;
              }
        
                       
             
        
              // Check phone number format
              if (!isValidPhoneNumber(phone)) {
                alert('Please enter a valid phone number.');
                return false;
              }
        
              return true;
            }
        
            function isValidPhoneNumber(phone) {
              // Regular expression for phone number validation
              var phoneRegex = /^[0-9]{10}$/;
              return phoneRegex.test(phone);
            }
          });
        
        
          function Read(){
            $.ajax({
                async: true,
                url: 'EmployeeList',
                type: 'post',
        
                data:{
                    res: 1,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response){
                    $('#emplist').html(response);
                }
            });
        }
        </script>  {% endcomment %}


        <script>
          $(document).ready(function() {
            if ($('#emplist') != null) {
              Read();
            }
            $('#EmployeeRegister').validate({
              rules: {
                username: {
                  required: true,
                  minlength: 4,
                  maxlength: 20,
                  {% comment %} remote: {
                    url: 'username_exists', // The URL to check if the username already exists
                    type: 'post',
                    data: {
                      username: function() {
                        return $('#id_username').val();
                      }
                    }
                 {% endcomment %}
                }, 
                password1: {
                  required: true,
                  minlength: 8,
                },
                password2: {
                  required: true,
                  equalTo: '#id_password1',
                },
                phone_number: {
                  required: true,
                  minlength: 10,
                  maxlength: 10,
                  digits: true,
                },
                emp_id: {
                  required: true,
                  minlength: 6,
                  maxlength: 6,
                  digits: true,
                },
              },
              messages: {
                username: {
                  required: 'Please enter a username.',
                  minlength: 'Username must be at least 4 characters long.',
                  maxlength: 'Username must be at most 20 characters long.',
                  {% comment %} remote: 'Username already exists. Please choose a different username.', // The message to display if the username already exists {% endcomment %}
                },
                password1: {
                  required: 'Please enter a password.',
                  minlength: 'Password must be at least 8 characters long.',
                },
                password2: {
                  required: 'Please confirm your password.',
                  equalTo: 'Passwords do not match.',
                },
                phone_number: {
                  required: 'Please enter a phone number.',
                  minlength: 'Phone number must be 10 digits long.',
                  maxlength: 'Phone number must be 10 digits long.',
                  digits: 'Please enter a valid phone number.',
                },
                emp_id: {
                  required: 'Please enter an employee ID.',
                  minlength: 'Employee ID must be 6 digits long.',
                  maxlength: 'Employee ID must be 6 digits long.',
                  digits: 'Please enter a valid employee ID.',
                },
              },
              
              submitHandler: function(form) {
                $.ajax({
                  type: 'post', // Get the form's method attribute
                  url: 'employeeadd', // Get the form's action attribute
                  data: $(form).serialize(), // Serialize the form data
                  success: function(response) {
                    // Handle the server's response here
                    alert('Form submitted successfully!');
                    Read();
                  },
                  error: function(xhr, status, error) {
                    // Handle errors here
                    alert('An error occurred while submitting the form.');
                    console.error(xhr.responseText);
                  }
                });
              }
            });
          

              $(document).on('click', '.delete', function(){
                  $id = $(this).attr('name');
                  $.ajax({
                      url: 'delete-wm' +"/"+ $id+"/",
                      type: 'POST',
                      data: {
                          csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                      },
                      success: function(){
                          Read();
                          alert("Deleted!");
                      }
                  });
              });
              
         
          
            function Read() {
              $.ajax({
                async: true,
                url: 'EmployeeList',
                type: 'post',
                data: {
                  res: 1,
                  csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                  $('#emplist').html(response);
                }
              });
            }
          });
        </script>
        
        

<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleMod">
    Add Employee +
  </button>
  <div id="emplist"></div>


<div class="modal fade" id="exampleMod" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">REGISTER</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
         {% comment %} form {% endcomment %}
         <form id = 'EmployeeRegister'>
            {% csrf_token %}


         {{form|crispy}}
          
        <div class=" forget">
           <br>

         <button type= "submit" class="btn btn-success w-100 btn-sm">Sign Up</button>
         {% comment %} <button type="submit"> submit </button> {% endcomment %}

        </form>


        {% endblock %}